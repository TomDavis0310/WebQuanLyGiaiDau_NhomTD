@page
@model IndexModel
@{
    ViewData["Title"] = "Hồ Sơ Cá Nhân";
    ViewData["ActivePage"] = ManageNavPages.Index;
}

<link rel="stylesheet" href="~/css/manage-layout.css" asp-append-version="true" />

<div class="profile-info-card fade-in">
    <!-- Status Message -->
    <partial name="_StatusMessage" for="StatusMessage" />
    
    <!-- Profile Avatar Section -->
    <div class="profile-avatar-section">
        <div class="avatar-placeholder">
            <i class="bi bi-person-fill"></i>
        </div>
        <h4 class="mt-3 mb-1">@Model.Username</h4>
        <p class="text-muted">@User.Identity.Name</p>
    </div>

    <!-- Profile Information Grid -->
    <div class="info-grid mb-4">
        <div class="info-item">
            <div class="info-item-label">
                <i class="bi bi-person-badge"></i>
                <span>Tên đăng nhập</span>
            </div>
            <div class="info-item-value">@Model.Username</div>
        </div>

        <div class="info-item">
            <div class="info-item-label">
                <i class="bi bi-envelope"></i>
                <span>Email</span>
            </div>
            <div class="info-item-value">
                @User.Identity.Name
                @if (Model.IsEmailConfirmed)
                {
                    <span class="badge badge-verified ms-2">
                        <i class="bi bi-check-circle"></i> Đã xác thực
                    </span>
                }
                else
                {
                    <span class="badge badge-unverified ms-2">
                        <i class="bi bi-exclamation-circle"></i> Chưa xác thực
                    </span>
                }
            </div>
        </div>

        <div class="info-item">
            <div class="info-item-label">
                <i class="bi bi-phone"></i>
                <span>Số điện thoại</span>
            </div>
            <div class="info-item-value">
                @if (!string.IsNullOrEmpty(Model.Input.PhoneNumber))
                {
                    @Model.Input.PhoneNumber
                }
                else
                {
                    <span class="text-muted">Chưa cập nhật</span>
                }
            </div>
        </div>

        <div class="info-item">
            <div class="info-item-label">
                <i class="bi bi-calendar-check"></i>
                <span>Ngày tham gia</span>
            </div>
            <div class="info-item-value">@DateTime.Now.ToString("dd/MM/yyyy")</div>
        </div>
    </div>

    <!-- Edit Form Section -->
    <div class="section-card">
        <div class="section-header">
            <i class="bi bi-pencil-square"></i>
            <h4>Cập Nhật Thông Tin</h4>
        </div>

        <form id="profile-form" method="post">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger-custom" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>
                    <strong>Có lỗi xảy ra!</strong> Vui lòng kiểm tra lại thông tin.
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        <input asp-for="Username" class="form-control" placeholder="Tên đăng nhập" disabled />
                        <label asp-for="Username" class="form-label">
                            <i class="bi bi-person me-2"></i>Tên đăng nhập
                        </label>
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle"></i> Tên đăng nhập không thể thay đổi
                        </small>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-floating">
                        <input asp-for="Input.PhoneNumber" class="form-control" placeholder="Số điện thoại" />
                        <label asp-for="Input.PhoneNumber" class="form-label">
                            <i class="bi bi-phone me-2"></i>Số điện thoại
                        </label>
                        <span asp-validation-for="Input.PhoneNumber" class="text-danger d-block mt-2"></span>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button id="update-profile-button" type="submit" class="btn-primary-gradient">
                    <i class="bi bi-check-lg"></i>
                    <span>Lưu thay đổi</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Quick Actions -->
    <div class="row g-3 mt-2">
        <div class="col-md-6">
            <a asp-page="./ChangePassword" class="btn btn-outline-primary-custom w-100">
                <i class="bi bi-shield-lock"></i>
                <span>Đổi mật khẩu</span>
            </a>
        </div>
        <div class="col-md-6">
            <a asp-page="./Email" class="btn btn-outline-primary-custom w-100">
                <i class="bi bi-envelope"></i>
                <span>Quản lý Email</span>
            </a>
        </div>
        <div class="col-md-6">
            <a asp-page="./TwoFactorAuthentication" class="btn btn-outline-primary-custom w-100">
                <i class="bi bi-shield-check"></i>
                <span>Xác thực 2 bước</span>
            </a>
        </div>
        <div class="col-md-6">
            <a asp-page="./PersonalData" class="btn btn-outline-primary-custom w-100">
                <i class="bi bi-database"></i>
                <span>Dữ liệu cá nhân</span>
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Add loading state to submit button
            $('#profile-form').on('submit', function() {
                const $btn = $('#update-profile-button');
                $btn.addClass('btn-loading');
                $btn.find('span').text('Đang lưu...');
                
                // Re-enable after 3 seconds
                setTimeout(function() {
                    $btn.removeClass('btn-loading');
                    $btn.find('span').text('Lưu thay đổi');
                }, 3000);
            });

            // Phone number formatting
            $('#Input_PhoneNumber').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.startsWith('84')) {
                    value = '+84 ' + value.substring(2);
                } else if (value.startsWith('0')) {
                    value = value.substring(1);
                    value = '+84 ' + value;
                }
                $(this).val(value);
            });

            // Add animation to cards
            $('.info-item').each(function(index) {
                $(this).css('animation-delay', (index * 0.1) + 's');
                $(this).addClass('fade-in');
            });
        });
    </script>
}
