@page
@model EmailModel
@{
    ViewData["Title"] = "Quản Lý Email";
    ViewData["ActivePage"] = ManageNavPages.Email;
}

<link rel="stylesheet" href="~/css/manage-layout.css" asp-append-version="true" />

<div class="profile-info-card fade-in">
    <partial name="_StatusMessage" for="StatusMessage" />
    
    <!-- Email Status Section -->
    <div class="section-card mb-4">
        <div class="section-header">
            <i class="bi bi-envelope-check"></i>
            <h4>Địa Chỉ Email Hiện Tại</h4>
        </div>

        <div class="info-grid">
            <div class="info-item">
                <div class="info-item-label">
                    <i class="bi bi-envelope"></i>
                    <span>Email đăng nhập</span>
                </div>
                <div class="info-item-value">
                    @Model.Email
                    @if (Model.IsEmailConfirmed)
                    {
                        <span class="badge badge-verified ms-2">
                            <i class="bi bi-check-circle-fill"></i> Đã xác thực
                        </span>
                    }
                    else
                    {
                        <span class="badge badge-unverified ms-2">
                            <i class="bi bi-exclamation-circle-fill"></i> Chưa xác thực
                        </span>
                    }
                </div>
            </div>

            @if (!Model.IsEmailConfirmed)
            {
                <div class="info-item">
                    <div class="info-item-label">
                        <i class="bi bi-shield-exclamation"></i>
                        <span>Trạng thái</span>
                    </div>
                    <div class="info-item-value">
                        <form method="post" asp-page-handler="SendVerificationEmail" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-primary-custom">
                                <i class="bi bi-send"></i> Gửi email xác thực
                            </button>
                        </form>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Change Email Section -->
    <div class="section-card">
        <div class="section-header">
            <i class="bi bi-arrow-left-right"></i>
            <h4>Thay Đổi Địa Chỉ Email</h4>
        </div>

        @if (!Model.IsEmailConfirmed)
        {
            <div class="alert alert-warning-custom mb-4">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>
                    <strong>Chú ý!</strong> Vui lòng xác thực email hiện tại trước khi thay đổi.
                </div>
            </div>
        }

        <form id="email-form" method="post">
            <div asp-validation-summary="All" class="alert alert-danger-custom" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>Vui lòng kiểm tra lại thông tin!</div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="form-floating">
                        <input asp-for="Input.NewEmail" 
                               class="form-control" 
                               autocomplete="email" 
                               aria-required="true" 
                               placeholder="Email mới" />
                        <label asp-for="Input.NewEmail" class="form-label">
                            <i class="bi bi-envelope-at me-2"></i>Email mới
                        </label>
                        <span asp-validation-for="Input.NewEmail" class="text-danger d-block mt-2"></span>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle"></i> 
                        Một email xác nhận sẽ được gửi đến địa chỉ email mới của bạn.
                    </small>
                </div>
            </div>

            <div class="text-center mt-4">
                <button id="change-email-button" 
                        type="submit" 
                        asp-page-handler="ChangeEmail" 
                        class="btn-primary-gradient">
                    <i class="bi bi-arrow-repeat"></i>
                    <span>Thay đổi email</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Security Info -->
    <div class="alert alert-info-custom mt-4">
        <i class="bi bi-shield-fill-check"></i>
        <div>
            <strong>Bảo mật:</strong> 
            Email được sử dụng để khôi phục tài khoản và nhận thông báo quan trọng. 
            Đảm bảo sử dụng email mà bạn có quyền truy cập.
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Add loading state to buttons
            $('button[type="submit"]').on('click', function() {
                const $btn = $(this);
                $btn.addClass('btn-loading');
                $btn.find('span').text('Đang xử lý...');
                
                setTimeout(function() {
                    $btn.removeClass('btn-loading');
                }, 3000);
            });

            // Email validation
            $('#Input_NewEmail').on('blur', function() {
                const email = $(this).val();
                const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                
                if (email && !emailRegex.test(email)) {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                }
            });
        });
    </script>
}
