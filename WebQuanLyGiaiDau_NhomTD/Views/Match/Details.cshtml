@model WebQuanLyGiaiDau_NhomTD.Models.MatchViewModel

@{
    ViewData["Title"] = "Chi Ti·∫øt Tr·∫≠n ƒê·∫•u";
    // Using properties from MatchViewModel now
    var matchSets = Model.MatchSets;
    var matchStatus = Model.MatchStatus;
    var matchEndTime = Model.MatchEndTime;
    var playerScorings = ViewBag.PlayerScorings as List<WebQuanLyGiaiDau_NhomTD.Models.PlayerScoring>;
    var highlightsVideo = ViewBag.HighlightsVideo as WebQuanLyGiaiDau_NhomTD.Models.YouTubeVideo;
    var liveStreamVideo = ViewBag.LiveStreamVideo as WebQuanLyGiaiDau_NhomTD.Models.YouTubeVideo;
    var recommendedVideos = ViewBag.RecommendedVideos as WebQuanLyGiaiDau_NhomTD.Models.YouTubeSearchResponse;
}

<h1 class="text-center text-info mt-4">üìã Chi Ti·∫øt Tr·∫≠n ƒê·∫•u</h1>

<div class="container bg-light shadow rounded p-4 mt-4 mb-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Th√¥ng Tin Tr·∫≠n ƒê·∫•u</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center mb-4">
                        <div class="col-md-4 col-6 text-center">
                            <h4 class="team-name">@Model.TeamA</h4>
                        </div>
                        <div class="col-md-4 col-12 order-md-1 order-last text-center my-3 my-md-0">
                            <div class="score-display p-3 bg-light rounded shadow-sm">
                                @if (matchStatus == "Completed" || matchStatus == "InProgress")
                                {
                                    <h2 class="mb-0 fw-bold">@(Model.ScoreTeamA ?? 0) - @(Model.ScoreTeamB ?? 0)</h2>
                                    <div class="badge @(matchStatus == "Completed" ? "bg-success" : "bg-danger") mt-2">
                                        @(matchStatus == "Completed" ? "ƒê√£ k·∫øt th√∫c" : "ƒêang di·ªÖn ra")
                                    </div>
                                }
                                else
                                {
                                    <h2 class="mb-0 fw-bold">VS</h2>
                                    <div class="badge bg-primary mt-2">S·∫Øp di·ªÖn ra</div>
                                }
                            </div>
                        </div>
                        <div class="col-md-4 col-6 text-center">
                            <h4 class="team-name">@Model.TeamB</h4>
                        </div>
                    </div>

                    <dl class="row">
                        <dt class="col-sm-3 fw-bold">Ng√†y Thi ƒê·∫•u:</dt>
                        <dd class="col-sm-9">
                            @if (Model.MatchDate != default(DateTime))
                            {
                                @Model.MatchDate.ToString("dd/MM/yyyy")
                            }
                            else
                            {
                                <span class="text-muted">Ch∆∞a x√°c ƒë·ªãnh</span>
                            }
                        </dd>

                        <dt class="col-sm-3 fw-bold">Gi·ªù Thi ƒê·∫•u:</dt>
                        <dd class="col-sm-9">
                            @if (Model.MatchTime.HasValue)
                            {
                                @Model.MatchTime.Value.ToString(@"hh\:mm")
                            }
                            else
                            {
                                <span>15:00</span>
                            }
                        </dd>

                        <dt class="col-sm-3 fw-bold">ƒê·ªãa ƒêi·ªÉm Thi ƒê·∫•u:</dt>
                        <dd class="col-sm-9">
                            @if (!string.IsNullOrEmpty(Model.Location))
                            {
                                @Model.Location
                            }
                            else
                            {
                                <span class="text-muted">Ch∆∞a x√°c ƒë·ªãnh</span>
                            }
                        </dd>

                        <dt class="col-sm-3 fw-bold">Th·ªùi Gian K·∫øt Th√∫c:</dt>
                        <dd class="col-sm-9">                            @{
                                string endTimeDisplay = "15:15";
                                if (Model.Tournament != null && (Model.Tournament.Name.Contains("5v5") || Model.Tournament.Name.Contains("5 vs 5")))
                                {
                                    endTimeDisplay = "16:08";
                                }
                            }
                            @Model.MatchEndTime.ToString("HH:mm")
                        </dd>

                        <dt class="col-sm-3 fw-bold">Gi·∫£i ƒê·∫•u:</dt>
                        <dd class="col-sm-9">
                            @if (Model.Tournament != null)
                            {
                                <a asp-controller="Tournament" asp-action="Details" asp-route-id="@Model.TournamentId">
                                    @Html.DisplayFor(model => model.Tournament.Name)
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">Ch∆∞a x√°c ƒë·ªãnh</span>
                            }
                        </dd>
                    </dl>
                </div>
            </div>

            @* Ph·∫ßn b√¨nh ch·ªçn *@
            @{
                var userVote = ViewBag.UserVote as WebQuanLyGiaiDau_NhomTD.Models.MatchVote;
            }
            
            @* Admin controls for winner voting *@
            @if (User.IsInRole(WebQuanLyGiaiDau_NhomTD.Models.UserModel.SD.Role_Admin))
            {
                <div class="card mb-3 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-gear me-2"></i>Admin: Qu·∫£n l√Ω b√¨nh ch·ªçn ƒë·ªôi th·∫Øng
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleWinnerVoting" 
                                   checked="@Model.AllowWinnerVoting" 
                                   data-match-id="@Model.Id">
                            <label class="form-check-label" for="toggleWinnerVoting">
                                <span id="winnerVotingLabel">@(Model.AllowWinnerVoting ? "B√¨nh ch·ªçn ƒë·ªôi th·∫Øng ƒëang B·∫¨T" : "B√¨nh ch·ªçn ƒë·ªôi th·∫Øng ƒëang T·∫ÆT")</span>
                            </label>
                        </div>
                    </div>
                </div>
            }

            @if (User.Identity.IsAuthenticated && Model.AllowWinnerVoting)
            {
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-hand-thumbs-up me-2"></i>B√¨nh Ch·ªçn ƒê·ªôi Th·∫Øng
                            <span class="badge bg-success ms-2">+3 ƒëi·ªÉm</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (userVote != null)
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-check-circle me-2"></i>
                                B·∫°n ƒë√£ b√¨nh ch·ªçn cho ƒë·ªôi: <strong>@userVote.VotedTeam</strong>
                                <small class="d-block text-muted mt-1">L√∫c @userVote.VoteTime.ToString("dd/MM/yyyy HH:mm")</small>
                            </div>
                        }
                        
                        <div class="row">
                            <div class="col-md-5">
                                <button type="button" class="btn btn-outline-primary w-100 vote-btn @(userVote?.VotedTeam == "TeamA" ? "active" : "")" 
                                        data-match-id="@Model.Id" data-team="TeamA">
                                    <i class="bi bi-trophy me-2"></i>
                                    @Model.TeamA
                                </button>
                            </div>
                            <div class="col-md-2 text-center d-flex align-items-center justify-content-center">
                                <span class="fw-bold text-muted">VS</span>
                            </div>
                            <div class="col-md-5">
                                <button type="button" class="btn btn-outline-success w-100 vote-btn @(userVote?.VotedTeam == "TeamB" ? "active" : "")" 
                                        data-match-id="@Model.Id" data-team="TeamB">
                                    <i class="bi bi-trophy me-2"></i>
                                    @Model.TeamB
                                </button>
                            </div>
                        </div>
                        
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            B·∫°n s·∫Ω nh·∫≠n 3 ƒëi·ªÉm khi b√¨nh ch·ªçn l·∫ßn ƒë·∫ßu. C√≥ th·ªÉ thay ƒë·ªïi l·ª±a ch·ªçn nhi·ªÅu l·∫ßn.
                        </small>
                    </div>
                </div>
            }
            else if (!User.Identity.IsAuthenticated)
            {
                <div class="card mb-4 border-warning">
                    <div class="card-body text-center">
                        <i class="bi bi-lock display-4 text-warning"></i>
                        <h5 class="mt-2">ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh ch·ªçn</h5>
                        <p class="text-muted">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ b√¨nh ch·ªçn ƒë·ªôi th·∫Øng</p>
                        <a href="/Account/Login" class="btn btn-warning">
                            <i class="bi bi-box-arrow-in-right me-2"></i>ƒêƒÉng nh·∫≠p
                        </a>
                    </div>
                </div>
            }
            else if (!Model.AllowWinnerVoting)
            {
                <div class="card mb-4 border-secondary">
                    <div class="card-body text-center">
                        <i class="bi bi-x-circle display-4 text-secondary"></i>
                        <h5 class="mt-2">B√¨nh ch·ªçn ƒë√£ ƒë√≥ng</h5>
                        <p class="text-muted">Ch·ª©c nƒÉng b√¨nh ch·ªçn cho tr·∫≠n ƒë·∫•u n√†y ƒë√£ b·ªã t·∫Øt b·ªüi admin</p>
                    </div>
                </div>
            }

            @if (matchSets != null && matchSets.Any())
            {
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">K·∫øt Qu·∫£ C√°c Hi·ªáp ƒê·∫•u</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-primary">
                                    <tr class="text-center">
                                        <th>Hi·ªáp</th>
                                        <th>@Model.TeamA</th>
                                        <th>@Model.TeamB</th>
                                        <th class="d-none d-md-table-cell">C·∫ßu Th·ªß Xu·∫•t S·∫Øc</th>
                                        <th class="d-none d-md-table-cell">ƒê·ªôi</th>
                                        <th class="d-none d-md-table-cell">ƒêi·ªÉm</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var set in matchSets)
                                    {
                                        <tr class="text-center">
                                            <td>@set.SetNumber</td>
                                            <td class="fw-bold">@set.ScoreTeamA</td>
                                            <td class="fw-bold">@set.ScoreTeamB</td>
                                            <td class="d-none d-md-table-cell">@set.BestPlayerName</td>
                                            <td class="d-none d-md-table-cell">@set.BestPlayerTeam</td>
                                            <td class="d-none d-md-table-cell">@set.BestPlayerPoints</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            <!-- Hi·ªÉn th·ªã th√¥ng tin c·∫ßu th·ªß xu·∫•t s·∫Øc tr√™n mobile -->
                            <div class="d-md-none mt-3">
                                <h6 class="text-center fw-bold">C·∫ßu Th·ªß Xu·∫•t S·∫Øc</h6>
                                @foreach (var set in matchSets)
                                {
                                    <div class="card mb-2">
                                        <div class="card-body p-2">
                                            <p class="mb-1"><strong>Hi·ªáp @set.SetNumber:</strong> @set.BestPlayerName</p>
                                            <p class="mb-1"><strong>ƒê·ªôi:</strong> @set.BestPlayerTeam</p>
                                            <p class="mb-0"><strong>ƒêi·ªÉm:</strong> @set.BestPlayerPoints</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (playerScorings != null && playerScorings.Any())
            {
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Chi Ti·∫øt Ghi ƒêi·ªÉm</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-warning">
                                    <tr class="text-center">
                                        <th>C·∫ßu Th·ªß</th>
                                        <th>ƒê·ªôi</th>
                                        <th>ƒêi·ªÉm S·ªë</th>
                                        <th>Th·ªùi Gian</th>
                                        <th>Ghi Ch√∫</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var scoring in playerScorings)
                                    {
                                        <tr class="text-center">
                                            <td>@scoring.Player.FullName (#@scoring.Player.Number)</td>
                                            <td>
                                                <span class="badge @(scoring.Player.Team.Name == Model.TeamA ? "bg-primary" : "bg-danger")">
                                                    @scoring.Player.Team.Name
                                                </span>
                                            </td>
                                            <td class="fw-bold">@scoring.Points</td>
                                            <td>@scoring.ScoringTime.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                            <td>@(string.IsNullOrEmpty(scoring.Notes) ? "-" : scoring.Notes)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }

            @if (Model.Statistics != null && Model.Statistics.Any())
            {
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Th·ªëng K√™ C·∫ßu Th·ªß</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-success">
                                    <tr class="text-center">
                                        <th>C·∫ßu Th·ªß</th>
                                        <th>ƒêi·ªÉm</th>
                                        <th>Ki·∫øn T·∫°o</th>
                                        <th>B·∫Øt B√≥ng</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var stat in Model.Statistics.OrderByDescending(s => s.Points))
                                    {
                                        <tr class="text-center">
                                            <td>
                                                <a asp-controller="Tournament" asp-action="FindPlayerByName" asp-route-playerName="@stat.PlayerName" asp-route-tournamentId="@Model.TournamentId" class="text-decoration-none">
                                                    @stat.PlayerName
                                                    <small class="d-block text-muted"><i class="bi bi-info-circle"></i> Nh·∫•n ƒë·ªÉ xem chi ti·∫øt</small>
                                                </a>
                                            </td>
                                            <td class="fw-bold">@stat.Points</td>
                                            <td>@stat.Assists</td>
                                            <td>@stat.Rebounds</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }

            @* YouTube Videos Section *@
            @if (highlightsVideo != null || liveStreamVideo != null || (recommendedVideos != null && recommendedVideos.Videos.Any()))
            {
                <style>
                    .youtube-section {
                        background: linear-gradient(135deg, #ff0000, #cc0000);
                        border-radius: 15px;
                        overflow: hidden;
                        box-shadow: 0 8px 25px rgba(255, 0, 0, 0.2);
                        margin-bottom: 30px;
                    }

                    .youtube-header {
                        background: rgba(0,0,0,0.2);
                        padding: 20px;
                        color: white;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                    }

                    .youtube-content {
                        background: white;
                        padding: 30px;
                    }

                    .video-card {
                        border-radius: 15px;
                        overflow: hidden;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                        transition: all 0.3s ease;
                        height: 100%;
                    }

                    .video-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    }

                    .video-player {
                        position: relative;
                        border-radius: 10px;
                        overflow: hidden;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    }

                    .live-indicator {
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: #ff0000;
                        color: white;
                        padding: 8px 15px;
                        border-radius: 20px;
                        font-size: 0.9rem;
                        font-weight: bold;
                        animation: pulse 2s infinite;
                        z-index: 10;
                    }

                    @@keyframes pulse {
                        0% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.8; transform: scale(1.05); }
                        100% { opacity: 1; transform: scale(1); }
                    }

                    .video-info {
                        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                        padding: 20px;
                        border-radius: 10px;
                        margin-top: 15px;
                    }

                    .recommended-video {
                        transition: all 0.3s ease;
                        border-radius: 10px;
                        overflow: hidden;
                        cursor: pointer;
                    }

                    .recommended-video:hover {
                        transform: scale(1.02);
                        box-shadow: 0 4px 15px rgba(255, 0, 0, 0.2);
                    }

                    .video-thumbnail {
                        position: relative;
                        overflow: hidden;
                        border-radius: 8px;
                    }

                    .video-thumbnail img {
                        transition: transform 0.3s ease;
                    }

                    .video-thumbnail:hover img {
                        transform: scale(1.1);
                    }

                    .play-overlay {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.7);
                        color: white;
                        border-radius: 50%;
                        width: 60px;
                        height: 60px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.5rem;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }

                    .video-thumbnail:hover .play-overlay {
                        opacity: 1;
                    }
                </style>

                <div class="youtube-section">
                    <div class="youtube-header">
                        <h4 class="mb-0">
                            <i class="bi bi-youtube me-2"></i>
                            Video Highlights & Live Stream
                        </h4>
                        <p class="mb-0 mt-2 opacity-75">Xem video highlights v√† live stream c·ªßa tr·∫≠n ƒë·∫•u</p>
                    </div>
                    <div class="youtube-content">
                        <div class="row">
                            @* Highlights Video *@
                            @if (highlightsVideo != null)
                            {
                                <div class="col-lg-6 mb-4">
                                    <div class="video-card">
                                        <div class="bg-warning text-dark p-3">
                                            <h5 class="mb-0">
                                                <i class="bi bi-camera-video me-2"></i>
                                                Video Highlights
                                            </h5>
                                        </div>
                                        <div class="video-player">
                                            <div class="ratio ratio-16x9">
                                                <iframe src="@highlightsVideo.EmbedUrl"
                                                        title="@highlightsVideo.Title"
                                                        frameborder="0"
                                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                        allowfullscreen>
                                                </iframe>
                                            </div>
                                        </div>
                                        <div class="video-info">
                                            <h6 class="fw-bold mb-2">@highlightsVideo.Title</h6>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="text-muted small">
                                                    <i class="bi bi-eye me-1"></i> @highlightsVideo.ViewCount.ToString("N0") l∆∞·ª£t xem
                                                    <br>
                                                    <i class="bi bi-calendar me-1"></i> @highlightsVideo.PublishedAt.ToString("dd/MM/yyyy")
                                                </div>
                                                <a href="@highlightsVideo.VideoUrl" target="_blank" class="btn btn-danger btn-sm">
                                                    <i class="bi bi-youtube"></i> YouTube
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            @* Live Stream Video *@
                            @if (liveStreamVideo != null)
                            {
                                <div class="col-lg-6 mb-4">
                                    <div class="video-card">
                                        <div class="bg-danger text-white p-3">
                                            <h5 class="mb-0">
                                                <i class="bi bi-broadcast me-2"></i>
                                                Live Stream
                                            </h5>
                                        </div>
                                        <div class="video-player">
                                            @if (liveStreamVideo.IsLiveStream && liveStreamVideo.LiveStatus == "live")
                                            {
                                                <div class="live-indicator">
                                                    <i class="bi bi-broadcast me-1"></i>LIVE
                                                </div>
                                            }
                                            <div class="ratio ratio-16x9">
                                                <iframe src="@liveStreamVideo.EmbedUrl"
                                                        title="@liveStreamVideo.Title"
                                                        frameborder="0"
                                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                        allowfullscreen>
                                                </iframe>
                                            </div>
                                        </div>
                                        <div class="video-info">
                                            <h6 class="fw-bold mb-2">@liveStreamVideo.Title</h6>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="text-muted small">
                                                    @if (liveStreamVideo.IsLiveStream)
                                                    {
                                                        @if (liveStreamVideo.LiveStatus == "live")
                                                        {
                                                            <span class="badge bg-danger me-2">
                                                                <i class="bi bi-broadcast"></i> ƒêang ph√°t tr·ª±c ti·∫øp
                                                            </span>
                                                        }
                                                        else if (liveStreamVideo.LiveStatus == "upcoming")
                                                        {
                                                            <span class="badge bg-warning me-2">
                                                                <i class="bi bi-clock"></i> S·∫Øp ph√°t tr·ª±c ti·∫øp
                                                            </span>
                                                        }
                                                        <br>
                                                    }
                                                    <i class="bi bi-calendar me-1"></i> @liveStreamVideo.PublishedAt.ToString("dd/MM/yyyy")
                                                </div>
                                                <a href="@liveStreamVideo.VideoUrl" target="_blank" class="btn btn-danger btn-sm">
                                                    <i class="bi bi-youtube"></i> YouTube
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        @* Recommended Videos *@
                        @if (recommendedVideos != null && recommendedVideos.Videos.Any())
                        {
                            <div class="mt-5">
                                <div class="d-flex align-items-center mb-4">
                                    <h4 class="mb-0 me-3">
                                        <i class="bi bi-stars text-warning me-2"></i>
                                        Video ƒê·ªÅ Xu·∫•t
                                    </h4>
                                    <div class="flex-grow-1">
                                        <hr class="my-0">
                                    </div>
                                </div>
                                <div class="row g-3">
                                    @foreach (var video in recommendedVideos.Videos.Take(4))
                                    {
                                        <div class="col-lg-3 col-md-6">
                                            <div class="recommended-video card h-100 border-0">
                                                <div class="video-thumbnail position-relative">
                                                    <img src="@video.ThumbnailUrl" class="card-img-top" alt="@video.Title" style="height: 140px; object-fit: cover;">
                                                    <div class="play-overlay">
                                                        <i class="bi bi-play-fill"></i>
                                                    </div>
                                                </div>
                                                <div class="card-body p-3 d-flex flex-column">
                                                    <h6 class="card-title fw-bold mb-2" style="font-size: 0.9rem; line-height: 1.3;" title="@video.Title">
                                                        @(video.Title.Length > 50 ? video.Title.Substring(0, 50) + "..." : video.Title)
                                                    </h6>
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <small class="text-muted">
                                                            <i class="bi bi-eye me-1"></i>@video.ViewCount.ToString("N0")
                                                        </small>
                                                        <small class="text-muted">
                                                            @video.PublishedAt.ToString("dd/MM")
                                                        </small>
                                                    </div>
                                                    <small class="text-muted d-block mb-3" style="font-size: 0.8rem;">
                                                        <i class="bi bi-person me-1"></i>@video.ChannelTitle
                                                    </small>
                                                    <div class="mt-auto">
                                                        <a href="@video.VideoUrl" target="_blank" class="btn btn-danger btn-sm w-100 mb-2">
                                                            <i class="bi bi-play-circle me-1"></i> Xem Video
                                                        </a>
                                                        <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="showVideoDetails('@video.VideoId', '@Html.Raw(video.Title.Replace("'", "\\'"))')">
                                                            <i class="bi bi-info-circle me-1"></i> Xem Chi Ti·∫øt
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="text-center mt-4">
                                    <a href="/YouTube/Search?query=@Uri.EscapeDataString(Model.Tournament?.Name + " " + Model.Tournament?.Sports?.Name)"
                                       class="btn btn-outline-danger">
                                        <i class="bi bi-search me-2"></i>Xem Th√™m Video
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="mt-4">
                <div class="row">
                    @if (User.IsInRole(WebQuanLyGiaiDau_NhomTD.Models.UserModel.SD.Role_Admin))
                    {
                        <div class="col-md-6 mb-3 text-center text-md-start">
                            <a asp-action="ManagePlayerScoring" asp-route-id="@Model?.Id" class="btn btn-warning me-2 mb-2 mb-md-0">
                                <i class="bi bi-person-badge"></i> <span class="d-none d-sm-inline">Qu·∫£n L√Ω ƒêi·ªÉm S·ªë</span><span class="d-inline d-sm-none">ƒêi·ªÉm S·ªë</span>
                            </a>
                            <a asp-action="UpdateScore" asp-route-id="@Model?.Id" class="btn btn-primary me-2 mb-2 mb-md-0">
                                <i class="bi bi-graph-up"></i> <span class="d-none d-sm-inline">C·∫≠p Nh·∫≠t K·∫øt Qu·∫£</span><span class="d-inline d-sm-none">K·∫øt Qu·∫£</span>
                            </a>
                            <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-info me-2 mb-2 mb-md-0">
                                <i class="bi bi-pencil"></i> <span class="d-none d-sm-inline">Ch·ªânh S·ª≠a</span><span class="d-inline d-sm-none">S·ª≠a</span>
                            </a>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#youtubeModal">
                                <i class="bi bi-youtube"></i> <span class="d-none d-sm-inline">Qu·∫£n L√Ω Video</span><span class="d-inline d-sm-none">Video</span>
                            </button>
                        </div>
                        <div class="col-md-6 text-center text-md-end">
                            <a asp-controller="Tournament" asp-action="Details" asp-route-id="@Model.TournamentId" class="btn btn-primary me-2 mb-2 mb-md-0">
                                <i class="bi bi-trophy"></i> <span class="d-none d-sm-inline">Xem Gi·∫£i ƒê·∫•u</span><span class="d-inline d-sm-none">Gi·∫£i ƒê·∫•u</span>
                            </a>
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Quay L·∫°i</span><span class="d-inline d-sm-none">Quay L·∫°i</span>
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="col-12 text-center">
                            <a asp-controller="Tournament" asp-action="Details" asp-route-id="@Model.TournamentId" class="btn btn-primary me-2 mb-2 mb-md-0">
                                <i class="bi bi-trophy"></i> <span class="d-none d-sm-inline">Xem Gi·∫£i ƒê·∫•u</span><span class="d-inline d-sm-none">Gi·∫£i ƒê·∫•u</span>
                            </a>
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Quay L·∫°i Danh S√°ch</span><span class="d-inline d-sm-none">Quay L·∫°i</span>
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@* YouTube Management Modal *@
@if (User.IsInRole(WebQuanLyGiaiDau_NhomTD.Models.UserModel.SD.Role_Admin))
{
    <div class="modal fade" id="youtubeModal" tabindex="-1" aria-labelledby="youtubeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="youtubeModalLabel">
                        <i class="bi bi-youtube"></i> Qu·∫£n L√Ω Video YouTube
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="youtubeForm">
                        <input type="hidden" id="matchId" value="@Model.Id" />

                        <div class="mb-3">
                            <label for="highlightsUrl" class="form-label">
                                <i class="bi bi-camera-video"></i> URL Video Highlights
                            </label>
                            <input type="url" class="form-control" id="highlightsUrl"
                                   @* value="@Model.HighlightsVideoUrl" *@
                                   placeholder="https://www.youtube.com/watch?v=...">
                            <div class="form-text">Nh·∫≠p URL video highlights c·ªßa tr·∫≠n ƒë·∫•u t·ª´ YouTube</div>
                        </div>

                        <div class="mb-3">
                            <label for="liveStreamUrl" class="form-label">
                                <i class="bi bi-broadcast"></i> URL Live Stream
                            </label>
                            <input type="url" class="form-control" id="liveStreamUrl"
                                   @* value="@Model.LiveStreamUrl" *@
                                   placeholder="https://www.youtube.com/watch?v=...">
                            <div class="form-text">Nh·∫≠p URL live stream c·ªßa tr·∫≠n ƒë·∫•u t·ª´ YouTube</div>
                        </div>

                        <div class="mb-3">
                            <label for="videoDescription" class="form-label">
                                <i class="bi bi-card-text"></i> M√¥ t·∫£ Video
                            </label>
                            <textarea class="form-control" id="videoDescription" rows="3"
                                      placeholder="M√¥ t·∫£ v·ªÅ video...">@* @Model.VideoDescription *@</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-info w-100 mb-2" onclick="searchHighlights()">
                                    <i class="bi bi-search"></i> T√¨m Video Highlights
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-warning w-100 mb-2" onclick="searchLiveStreams()">
                                    <i class="bi bi-broadcast"></i> T√¨m Live Stream
                                </button>
                            </div>
                        </div>

                        <div id="searchResults" class="mt-3" style="display: none;">
                            <h6>K·∫øt qu·∫£ t√¨m ki·∫øm:</h6>
                            <div id="videoResults" class="row"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveYouTubeUrls()">
                        <i class="bi bi-check"></i> L∆∞u Thay ƒê·ªïi
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<script>
function searchHighlights() {
    const query = `@Model.TeamA vs @Model.TeamB highlights @Model.Tournament?.Name`;
    searchVideos(query, 'highlights');
}

function searchLiveStreams() {
    const query = `@Model.TeamA vs @Model.TeamB live @Model.Tournament?.Name`;
    searchVideos(query, 'live');
}

function searchVideos(query, type) {
    const url = type === 'highlights'
        ? `/YouTube/SearchHighlights?query=${encodeURIComponent(query)}&maxResults=6`
        : `/YouTube/SearchLiveStreams?query=${encodeURIComponent(query)}&maxResults=6`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.data.videos, type);
            } else {
                alert('L·ªói khi t√¨m ki·∫øm video: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm video');
        });
}

function displaySearchResults(videos, type) {
    const resultsDiv = document.getElementById('videoResults');
    const searchResultsDiv = document.getElementById('searchResults');

    resultsDiv.innerHTML = '';

    videos.forEach(video => {
        const videoCard = `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <img src="${video.thumbnailUrl}" class="card-img-top" style="height: 120px; object-fit: cover;">
                    <div class="card-body p-2">
                        <h6 class="card-title small">${video.title}</h6>
                        <p class="card-text text-muted small">
                            <i class="bi bi-eye"></i> ${video.viewCount.toLocaleString()} l∆∞·ª£t xem<br>
                            <small>${video.channelTitle}</small>
                        </p>
                        <div class="d-grid gap-1">
                            <button class="btn btn-sm btn-danger" onclick="selectVideo('${video.videoUrl}', '${type}')">
                                <i class="bi bi-check"></i> Ch·ªçn Video N√†y
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="showVideoPreview('${video.videoUrl}', '${video.title.replace(/'/g, "\\'")}')" data-bs-toggle="modal" data-bs-target="#videoPreviewModal">
                                <i class="bi bi-eye"></i> Xem Tr∆∞·ªõc
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        resultsDiv.innerHTML += videoCard;
    });

    searchResultsDiv.style.display = 'block';
}

function selectVideo(videoUrl, type) {
    if (type === 'highlights') {
        document.getElementById('highlightsUrl').value = videoUrl;
    } else {
        document.getElementById('liveStreamUrl').value = videoUrl;
    }

    // Hide search results
    document.getElementById('searchResults').style.display = 'none';
}

function showVideoDetails(videoId, title) {
    // Create modal for video details if it doesn't exist
    let modal = document.getElementById('videoDetailsModal');
    if (!modal) {
        const modalHTML = `
            <div class="modal fade" id="videoDetailsModal" tabindex="-1" aria-labelledby="videoDetailsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title" id="videoDetailsModalLabel">
                                <i class="bi bi-info-circle"></i> Chi Ti·∫øt Video
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="videoDetailsContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x"></i> ƒê√≥ng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('videoDetailsModal');
    }

    // Show modal and load video details
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // Load video details
    fetch(`/YouTube/GetVideoDetails?videoId=${videoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const video = data.data;
                document.getElementById('videoDetailsContent').innerHTML = `
                    <div class="ratio ratio-16x9 mb-3">
                        <iframe src="https://www.youtube.com/embed/${videoId}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                    </div>
                    <h6 class="fw-bold">${video.title}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted d-block"><i class="bi bi-person"></i> K√™nh: ${video.channelTitle}</small>
                            <small class="text-muted d-block"><i class="bi bi-eye"></i> L∆∞·ª£t xem: ${video.viewCount.toLocaleString()}</small>
                            <small class="text-muted d-block"><i class="bi bi-calendar"></i> Ng√†y ƒëƒÉng: ${new Date(video.publishedAt).toLocaleDateString('vi-VN')}</small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted d-block"><i class="bi bi-clock"></i> Th·ªùi l∆∞·ª£ng: ${video.duration || 'N/A'}</small>
                            <small class="text-muted d-block"><i class="bi bi-heart"></i> L∆∞·ª£t th√≠ch: ${(video.likeCount || 0).toLocaleString()}</small>
                            <small class="text-muted d-block"><i class="bi bi-chat"></i> B√¨nh lu·∫≠n: ${(video.commentCount || 0).toLocaleString()}</small>
                        </div>
                    </div>
                    <hr>
                    <div class="description-container">
                        <p class="small">${video.description ? video.description.substring(0, 300) + '...' : 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                    </div>
                    <div class="text-center mt-3">
                        <a href="${video.videoUrl}" target="_blank" class="btn btn-danger">
                            <i class="bi bi-youtube"></i> Xem Tr√™n YouTube
                        </a>
                    </div>
                `;
            } else {
                document.getElementById('videoDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt video: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('videoDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> C√≥ l·ªói x·∫£y ra khi t·∫£i chi ti·∫øt video.
                </div>
            `;
        });
}

function showVideoPreview(videoUrl, title) {
    const videoId = videoUrl.split('v=')[1]?.split('&')[0];
    if (videoId) {
        showVideoDetails(videoId, title);
    }
}

function saveYouTubeUrls() {
    const matchId = document.getElementById('matchId').value;
    const highlightsUrl = document.getElementById('highlightsUrl').value;
    const liveStreamUrl = document.getElementById('liveStreamUrl').value;
    const description = document.getElementById('videoDescription').value;

    const formData = new FormData();
    formData.append('matchId', matchId);
    formData.append('highlightsUrl', highlightsUrl);
    formData.append('liveStreamUrl', liveStreamUrl);
    formData.append('description', description);

    fetch('/YouTube/UpdateMatchVideo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('C·∫≠p nh·∫≠t video th√†nh c√¥ng!');
            location.reload(); // Reload page to show updated videos
        } else {
            alert('L·ªói: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra khi l∆∞u video');
    });
}

// Vote functionality
document.querySelectorAll('.vote-btn').forEach(button => {
    button.addEventListener('click', function() {
        const matchId = this.getAttribute('data-match-id');
        const team = this.getAttribute('data-team');
        
        // Disable all vote buttons
        document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
        
        const formData = new FormData();
        formData.append('matchId', matchId);
        formData.append('votedTeam', team);
        formData.append('__RequestVerificationToken', 
            document.querySelector('input[name="__RequestVerificationToken"]').value);
        
        fetch('/Voting/VoteMatch', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI to show the vote
                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn === this) {
                        btn.classList.add('active');
                    }
                });
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                this.closest('.card-body').insertBefore(alertDiv, this.closest('.row'));
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            } else {
                alert('L·ªói: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi b√¨nh ch·ªçn');
        })
        .finally(() => {
            // Re-enable buttons
            document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
        });
    });
});

// Admin toggle winner voting
const toggleWinnerVoting = document.getElementById('toggleWinnerVoting');
if (toggleWinnerVoting) {
    toggleWinnerVoting.addEventListener('change', function() {
        const matchId = this.getAttribute('data-match-id');
        const label = document.getElementById('winnerVotingLabel');
        
        fetch('/Match/ToggleWinnerVoting', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: `matchId=${matchId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                label.textContent = data.allowVoting ? "B√¨nh ch·ªçn ƒë·ªôi th·∫Øng ƒëang B·∫¨T" : "B√¨nh ch·ªçn ƒë·ªôi th·∫Øng ƒëang T·∫ÆT";
                
                // Reload page to update voting UI
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('L·ªói: ' + data.message);
                this.checked = !this.checked; // Revert toggle
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra');
            this.checked = !this.checked; // Revert toggle
        });
    });
}
</script>
