@model WebQuanLyGiaiDau_NhomTD.Models.Tournament
@using WebQuanLyGiaiDau_NhomTD.Models.UserModel

@{
    ViewData["Title"] = "Chi Tiết Giải Đấu";
    var teams = ViewBag.Teams as List<WebQuanLyGiaiDau_NhomTD.Models.Team>;
    var matches = ViewBag.Matches as List<WebQuanLyGiaiDau_NhomTD.Models.Match>;
    var teamRankings = ViewBag.TeamRankings as List<dynamic>;
    var matchStatus = ViewBag.MatchStatus as Dictionary<int, string>;
}

<div class="container mt-4">
    <h1 class="text-center text-primary mb-4">
        <i class="bi bi-info-circle"></i> Chi Tiết Giải Đấu
    </h1>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">@Model.Name</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        @if (!string.IsNullOrEmpty(Model.ImageUrl))
                        {
                            <div class="col-md-4 text-center mb-3">
                                <img src="@Model.ImageUrl" alt="Ảnh Giải Đấu" class="img-fluid rounded border" style="max-height: 200px;" />
                            </div>
                            <div class="col-md-8">
                                <dl class="row">
                                    <dt class="col-sm-4 fw-bold">Mô Tả</dt>
                                    <dd class="col-sm-8">@Html.DisplayFor(model => model.Description)</dd>

                                    <dt class="col-sm-4 fw-bold">Ngày Bắt Đầu</dt>
                                    <dd class="col-sm-8">@Model.StartDate.ToString("dd/MM/yyyy")</dd>

                                    <dt class="col-sm-4 fw-bold">Ngày Kết Thúc</dt>
                                    <dd class="col-sm-8">@Model.EndDate.ToString("dd/MM/yyyy")</dd>

                                    <dt class="col-sm-4 fw-bold">Môn Thể Thao</dt>
                                    <dd class="col-sm-8">@(Model.Sports?.Name ?? "Không xác định")</dd>
                                </dl>
                            </div>
                        }
                        else
                        {
                            <div class="col-md-12">
                                <dl class="row">
                                    <dt class="col-sm-3 fw-bold">Mô Tả</dt>
                                    <dd class="col-sm-9">@Html.DisplayFor(model => model.Description)</dd>

                                    <dt class="col-sm-3 fw-bold">Ngày Bắt Đầu</dt>
                                    <dd class="col-sm-9">@Model.StartDate.ToString("dd/MM/yyyy")</dd>

                                    <dt class="col-sm-3 fw-bold">Ngày Kết Thúc</dt>
                                    <dd class="col-sm-9">@Model.EndDate.ToString("dd/MM/yyyy")</dd>

                                    <dt class="col-sm-3 fw-bold">Môn Thể Thao</dt>
                                    <dd class="col-sm-9">@(Model.Sports?.Name ?? "Không xác định")</dd>
                                </dl>
                            </div>
                        }
                    </div>

                    <!-- Hiển thị các đội tham gia -->
                    <div class="mt-4">
                        <h5 class="text-primary mb-3">
                            <i class="bi bi-people-fill"></i> Các Đội Tham Gia
                        </h5>

                        @if (teams != null && teams.Any())
                        {
                            <div class="accordion" id="teamsAccordion">
                                @foreach (var team in teams)
                                {
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading@(team.TeamId)">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                    data-bs-target="#collapse@(team.TeamId)" aria-expanded="false" aria-controls="collapse@(team.TeamId)">
                                                @if (!string.IsNullOrEmpty(team.LogoUrl))
                                                {
                                                    <img src="@team.LogoUrl" alt="Logo @team.Name" class="me-2" style="height: 30px; width: auto;" />
                                                }
                                                <strong>@team.Name</strong> - HLV: @team.Coach
                                            </button>
                                        </h2>
                                        <div id="collapse@(team.TeamId)" class="accordion-collapse collapse"
                                             aria-labelledby="heading@(team.TeamId)" data-bs-parent="#teamsAccordion">
                                            <div class="accordion-body">
                                                <h6 class="text-secondary mb-2">Danh Sách Cầu Thủ:</h6>
                                                @if (team.Players != null && team.Players.Any())
                                                {
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Ảnh</th>
                                                                    <th>Số Áo</th>
                                                                    <th>Họ Tên</th>
                                                                    <th>Vị Trí</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var player in team.Players)
                                                                {
                                                                    <tr>
                                                                        <td>
                                                                            @if (!string.IsNullOrEmpty(player.ImageUrl))
                                                                            {
                                                                                <img src="@player.ImageUrl" alt="Ảnh @player.FullName" class="rounded-circle" style="height: 40px; width: 40px; object-fit: cover;" />
                                                                            }
                                                                            else
                                                                            {
                                                                                <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" style="height: 40px; width: 40px;">
                                                                                    <i class="bi bi-person"></i>
                                                                                </div>
                                                                            }
                                                                        </td>
                                                                        <td>@player.Number</td>
                                                                        <td>@player.FullName</td>
                                                                        <td>@player.Position</td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <p class="text-muted fst-italic">Chưa có cầu thủ nào được đăng ký.</p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Chưa có đội bóng nào tham gia giải đấu này.
                            </div>
                        }
                    </div>

                    <!-- Không cần khai báo lại biến teamRankings vì đã khai báo ở đầu trang -->

                    <!-- Bảng xếp hạng và Lịch thi đấu -->
                    <div class="mt-4">
                        <!-- Tabs cho Bảng xếp hạng và Lịch thi đấu -->
                        <ul class="nav nav-pills mb-3" id="tournamentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="standings-tab" data-bs-toggle="pill" data-bs-target="#standings-content" type="button" role="tab" aria-controls="standings-content" aria-selected="true">
                                    <i class="bi bi-bar-chart-fill"></i> Bảng Xếp Hạng
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="schedule-tab" data-bs-toggle="pill" data-bs-target="#schedule-content" type="button" role="tab" aria-controls="schedule-content" aria-selected="false">
                                    <i class="bi bi-calendar-event"></i> Lịch Thi Đấu
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="player-stats-tab" data-bs-toggle="pill" data-bs-target="#player-stats-content" type="button" role="tab" aria-controls="player-stats-content" aria-selected="false">
                                    <i class="bi bi-person-badge"></i> Thống Kê Cầu Thủ
                                </button>
                            </li>
                        </ul>

                        <!-- Tab content -->
                        <div class="tab-content" id="tournamentTabsContent">
                            <!-- Bảng xếp hạng content -->
                            <div class="tab-pane fade show active" id="standings-content" role="tabpanel" aria-labelledby="standings-tab">
                                @if (teams != null && teams.Any() && teamRankings != null && teamRankings.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr class="text-center">
                                                    <th>Hạng</th>
                                                    <th>Đội</th>
                                                    <th>Trận</th>
                                                    <th>Thắng</th>
                                                    <th>Hòa</th>
                                                    <th>Thua</th>
                                                    <th>Ghi</th>
                                                    <th>Thủng</th>
                                                    <th>Hiệu số</th>
                                                    <th>Điểm</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < teamRankings.Count; i++)
                                                {
                                                    var ranking = teamRankings[i];
                                                    var team = ranking.Team;

                                                    <tr class="@(i < 3 ? "table-success" : "")">
                                                        <td class="text-center fw-bold">@(i + 1)</td>
                                                        <td>
                                                            @if (team != null)
                                                            {
                                                                if (!string.IsNullOrEmpty(team.LogoUrl))
                                                                {
                                                                    <img src="@team.LogoUrl" alt="Logo @team.Name" class="me-2" style="height: 24px; width: auto;" />
                                                                }
                                                                @team.Name
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">Không có đội</span>
                                                            }
                                                        </td>
                                                        <td class="text-center">@ranking.Played</td>
                                                        <td class="text-center">@ranking.Won</td>
                                                        <td class="text-center">@ranking.Drawn</td>
                                                        <td class="text-center">@ranking.Lost</td>
                                                        <td class="text-center">@ranking.PointsScored</td>
                                                        <td class="text-center">@ranking.PointsConceded</td>
                                                        <td class="text-center">@(ranking.PointDiff > 0 ? "+" + ranking.PointDiff : ranking.PointDiff.ToString())</td>
                                                        <td class="text-center fw-bold">@ranking.Points</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> Chưa có đội bóng nào tham gia giải đấu này.
                                    </div>
                                }
                            </div>

                            <!-- Lịch thi đấu content -->
                            <div class="tab-pane fade" id="schedule-content" role="tabpanel" aria-labelledby="schedule-tab">
                                @if (matches != null && matches.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-primary">
                                                <tr>
                                                    <th>Đội A</th>
                                                    <th class="text-center">Tỉ Số</th>
                                                    <th>Đội B</th>
                                                    <th class="text-center">Thời Gian Thi Đấu</th>
                                                    <th class="text-center">Trạng Thái</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var match in matches)
                                                {
                                                    // Lấy trạng thái trận đấu từ dictionary
                                                    string status = (matchStatus != null && matchStatus.ContainsKey(match.Id)) ? matchStatus[match.Id] : "Upcoming";

                                                    string statusText = status == "Completed" ? "Đã kết thúc" :
                                                                       (status == "InProgress" ? "Đang diễn ra" : "Sắp diễn ra");
                                                    string statusClass = status == "Completed" ? "bg-success" :
                                                                       (status == "InProgress" ? "bg-danger" : "bg-primary");

                                                    <tr>
                                                        <td class="fw-bold">
                                                            @if (!string.IsNullOrEmpty(match.TeamA))
                                                            {
                                                                @match.TeamA
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">Chưa xác định</span>
                                                            }
                                                        </td>
                                                        <td class="text-center">
                                                            @if (status == "Completed")
                                                            {
                                                                @if (match.ScoreTeamA.HasValue && match.ScoreTeamB.HasValue)
                                                                {
                                                                    <span class="badge bg-secondary">@match.ScoreTeamA - @match.ScoreTeamB</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-secondary">0 - 0</span>
                                                                }
                                                            }
                                                            else if (status == "InProgress")
                                                            {
                                                                @if (match.ScoreTeamA.HasValue && match.ScoreTeamB.HasValue)
                                                                {
                                                                    <span class="badge bg-danger">@match.ScoreTeamA - @match.ScoreTeamB</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-danger">0 - 0</span>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">VS</span>
                                                            }
                                                        </td>
                                                        <td class="fw-bold">
                                                            @if (!string.IsNullOrEmpty(match.TeamB))
                                                            {
                                                                @match.TeamB
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">Chưa xác định</span>
                                                            }
                                                        </td>
                                                        <td class="text-center">
                                                            @if (match.MatchDate != default(DateTime))
                                                            {
                                                                <div>@match.MatchDate.ToString("dd/MM/yyyy")</div>
                                                                <div><small class="text-muted">15:00 - 15:15</small></div>
                                                                <div><small class="text-muted fst-italic">(Hoặc đến khi đạt 21 điểm)</small></div>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">Chưa xác định</span>
                                                            }
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge @statusClass">@statusText</span>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> Chưa có trận đấu nào được lên lịch cho giải đấu này.
                                    </div>
                                }
                            </div>

                            <!-- Thống kê cầu thủ content -->
                            <div class="tab-pane fade" id="player-stats-content" role="tabpanel" aria-labelledby="player-stats-tab">
                                @{
                                    var playerStats = ViewBag.PlayerStats as List<dynamic>;
                                }

                                @if (playerStats != null && playerStats.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-primary">
                                                <tr class="text-center">
                                                    <th>Hạng</th>
                                                    <th>Cầu Thủ</th>
                                                    <th>Đội</th>
                                                    <th class="text-center">Trận</th>
                                                    <th class="text-center">Điểm</th>
                                                    <th class="text-center">TB Điểm</th>
                                                    <th class="text-center">Kiến Tạo</th>
                                                    <th class="text-center">Bắt Bóng</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < playerStats.Count; i++)
                                                {
                                                    var player = playerStats[i];
                                                    <tr class="@(i < 3 ? "table-warning" : "")">
                                                        <td class="text-center fw-bold">@(i + 1)</td>
                                                        <td>@player.PlayerName</td>
                                                        <td>@player.Team</td>
                                                        <td class="text-center">@player.GamesPlayed</td>
                                                        <td class="text-center fw-bold">@player.TotalPoints</td>
                                                        <td class="text-center">@player.PointsPerGame</td>
                                                        <td class="text-center">@player.TotalAssists</td>
                                                        <td class="text-center">@player.TotalRebounds</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> Chưa có thống kê cầu thủ nào cho giải đấu này.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>



                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            <a asp-action="Index" class="btn btn-secondary me-2">
                                <i class="bi bi-list"></i> Danh Sách Giải Đấu
                            </a>
                            @if (Model.SportsId > 0)
                            {
                                <a asp-controller="Sports" asp-action="List" asp-route-sportsId="@Model.SportsId" class="btn btn-info">
                                    <i class="bi bi-arrow-left"></i> Quay Lại Môn Thể Thao
                                </a>
                            }
                        </div>
                        <div>
                            @if (User.IsInRole(SD.Role_User) && Model.RegistrationStatus == "Open")
                            {
                                <a asp-action="Register" asp-route-id="@Model.Id" class="btn btn-success me-2">
                                    <i class="bi bi-person-plus"></i> Đăng Ký Tham Gia
                                </a>
                                <a asp-action="RegisterTeam" asp-route-id="@Model.Id" class="btn btn-primary me-2">
                                    <i class="bi bi-people-fill"></i> Đăng Ký Đội
                                </a>
                            }
                            @if (User.IsInRole(SD.Role_Admin))
                            {
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning me-2">
                                    <i class="bi bi-pencil"></i> Chỉnh Sửa
                                </a>
                                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">
                                    <i class="bi bi-trash"></i> Xóa
                                </a>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
